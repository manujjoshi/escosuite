<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50 text-gray-800">
    <div class="flex h-screen">
        {% include 'sidebar.html' %}

        <main class="flex-1 p-8 overflow-y-auto">
            <header class="flex justify-between items-center mb-8">
                <h2 class="text-3xl font-bold text-gray-900">Database Management</h2>
                <div class="flex items-center">
                    <!-- <div class="relative mr-4">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input type="text" placeholder="Search..." class="bg-white border border-gray-300 rounded-full py-2 pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button class="mr-4 p-2 rounded-full hover:bg-gray-200"><i class="fas fa-bell"></i></button>
                    <div class="flex items-center mr-4"><img src="https://placehold.co/40x40/4338ca/ffffff?text=U" alt="User Avatar" class="rounded-full w-10 h-10"></div> -->
                </div>
            </header>

            <!-- Action Bar -->
            <div class="bg-white p-4 rounded-lg shadow-md mb-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <form id="importForm" action="{{ url_for('dbm_import') }}" method="POST" enctype="multipart/form-data" class="flex items-center">
                            <input type="hidden" name="table" value="{{ selected_table }}">
                            <label for="excelInput" class="inline-flex items-center px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg cursor-pointer shadow">
                                <i class="fas fa-file-excel mr-2"></i>Import Excel
                            </label>
                            <input id="excelInput" type="file" name="excel_file" accept=".xlsx,.xls" class="hidden">
                        </form>
                        <div class="w-px h-8 bg-gray-300"></div>
                        <a href="{{ url_for('dbm_export', table=selected_table) }}" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg shadow">
                            <i class="fas fa-download mr-2"></i>Download Excel
                        </a>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center">
                            <label class="text-lg font-medium-bold text-gray-700 mr-2">Select Table:</label>
                            <div class="relative">
                                <i class="fas fa-table absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                <select id="tableSelector" class="pl-10 pr-8 border border-gray-300 bg-gray-50 rounded-full px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm appearance-none" style="-webkit-appearance: none; -moz-appearance: none;">
                                {% for table in tables %}
                                <option value="{{ table }}" {% if table == selected_table %}selected{% endif %}>{{ table_display_names.get(table, table) }}</option>
                                {% endfor %}
                                </select>
                                <i class="fas fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                            </div>
                        </div>
                        
                        <div class="flex items-center">
                            <label class="text-lg font-medium-bold text-gray-700 mr-2">Search in table:</label>
                            <form method="GET" class="flex items-center bg-gray-100 rounded-full px-1 py-1 shadow-inner">
                                <input type="hidden" name="table" value="{{ selected_table }}">
                                <i class="fas fa-search text-gray-400"></i>
                                <input type="text" name="search" value="{{ search_query }}" placeholder="Search..." 
                                       class="bg-transparent px-3 py-2 focus:outline-none w-56">
                                <button type="submit" class="ml-1 px-3 py-1.5 bg-gray-700 hover:bg-gray-800 text-white rounded-full shadow-sm">Go</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="bg-white rounded-lg shadow-md">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold text-gray-900 uppercase">
                            {{ table_display_names.get(selected_table, selected_table) if selected_table else 'Render All Databases according to the Table selected' }}
                        </h3>
                        <div class="flex items-center space-x-3">
                            <button onclick="openCreateModal()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg">
                                <i class="fas fa-plus mr-2"></i>Create
                            </button>
                            <button onclick="dropTable()" class="px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg">
                                <i class="fas fa-times mr-2"></i>Drop
                            </button>
                        </div>
                    </div>
                    
                    {% if selected_table and table_columns %}
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border border-gray-300 rounded-lg border-collapse overflow-hidden">
                            <thead class="sticky top-0  border-b border-gray-200">
                                <tr>
                                    {% for column in table_columns %}
                                    <th class="p-3 font-semibold text-gray-700 border border-gray-300">{{ format_column_name(column.Field) }}</th>
                                    {% endfor %}
                                    <th class="p-3 font-semibold text-gray-700 border border-gray-300">ACTIONS</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in table_data %}
                                <tr class="hover:bg-gray-50">
                                    {% for column in table_columns %}
                                    <td class="p-3 border border-gray-300">
                                        {% set value = row[column.Field] %}
                                        {% if column.Field == 'scoring' %}
                                            {% set pct = (value or 0)|int %}
                                            {% set pct = 0 if pct < 0 else (100 if pct > 100 else pct) %}
                                            {% set bar_color = 'bg-red-500' %}
                                            {% if pct >= 80 %}
                                                {% set bar_color = 'bg-green-500' %}
                                            {% elif pct >= 50 %}
                                                {% set bar_color = 'bg-yellow-500' %}
                                            {% endif %}
                                            <div class="flex items-center space-x-2">
                                                <div class="w-32 h-3 bg-gray-100 rounded-full overflow-hidden">
                                                    <div class="h-3 {{ bar_color }}" style="width: {{ pct }}%"></div>
                                                </div>
                                                <span class="text-sm text-gray-700">{{ pct }}%</span>
                                            </div>
                                        {% elif value is none %}
                                            <span class="text-gray-400">NULL</span>
                                        {% elif column.Type.startswith('date') %}
                                            {{ value.strftime('%Y-%m-%d') if value else '-' }}
                                        {% elif column.Type.startswith('datetime') %}
                                            {{ value.strftime('%Y-%m-%d %H:%M:%S') if value else '-' }}
                                        {% else %}
                                            {{ value }}
                                        {% endif %}
                                    </td>
                                    {% endfor %}
                                    <td class="p-3 border border-gray-300">
                                        <div class="flex space-x-2">
                                            {% if selected_table == 'bid_incoming' %}
                                            <button onclick="openAssignModal({{ row[table_columns[0].Field] }}, '{{ row['b_name']|escape }}')" class="text-emerald-600 hover:text-emerald-800" title="Assign to Company">
                                                <i class="fas fa-share-square"></i>
                                            </button>
                                            {% elif selected_table == 'go_bids' %}
                                            <button onclick="openGoAssignModal({{ row[table_columns[0].Field] }}, '{{ row['b_name']|escape }}')" class="text-indigo-600 hover:text-indigo-800" title="Assign Department/Person">
                                                <i class="fas fa-user-plus"></i>
                                            </button>
                                            {% endif %}
                                            <button onclick="editRow({{ row[table_columns[0].Field] }})" 
                                                    class="text-blue-600 hover:text-blue-800">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button onclick="deleteRow({{ row[table_columns[0].Field] }})" 
                                                    class="text-red-600 hover:text-red-800">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                                
                                {% if not table_data %}
                                <tr>
                                    <td colspan="{{ table_columns|length + 1 }}" class="p-8 text-center text-gray-500">
                                        No data found
                                    </td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-12">
                        <i class="fas fa-database text-6xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500 text-lg">Select a table to view data</p>
                    </div>
                    {% endif %}
                </div>
                
                
            </div>
        </main>
    </div>

    <!-- Create/Update Modal -->
    <div id="crudModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6">
                    <h3 id="crudTitle" class="text-xl font-semibold text-gray-900 mb-4">Create Row</h3>
                    <form id="crudForm" method="POST">
                        <input type="hidden" name="table" value="{{ selected_table }}">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {% for column in table_columns %}
                                {% set field = column.Field %}
                                {% if column.Key != 'PRI' %}
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">{{ format_column_name(field) }}</label>
                                    <input type="text" name="{{ field }}" id="field_{{ field }}" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <div class="flex justify-end space-x-4 mt-6">
                            <button type="button" onclick="closeCrudModal()" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-lg">Cancel</button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">Save</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Assign Modal -->
    <div id="assignModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-lg w-full">
                <div class="p-6">
                    <h3 class="text-xl font-semibold text-gray-900 mb-4">Assign Bid to Company</h3>
                    <form id="assignForm" method="POST" action="/database-management/assign">
                        <input type="hidden" name="bid_id" id="assign_bid_id">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Bid</label>
                            <input id="assign_bid_name" class="w-full border border-gray-300 rounded-md px-3 py-2 bg-gray-100" disabled>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Company</label>
                            <select name="company_id" class="w-full border border-gray-300 rounded-md px-3 py-2" required>
                                {% for c in tables if false %}{% endfor %}
                                {% for c in companies or [] %}
                                <option value="{{ c.id }}">{{ c.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="flex justify-end space-x-4 mt-6">
                            <button type="button" onclick="closeAssignModal()" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-lg">Cancel</button>
                            <button type="submit" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg">Assign</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Assign Department/Person Modal for go_bids -->
    <div id="goAssignModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-lg w-full">
                <div class="p-6">
                    <h3 class="text-xl font-semibold text-gray-900 mb-4">Assign Department & Person</h3>
                    <form id="goAssignForm" method="POST" action="/database-management/assign-go">
                        <input type="hidden" name="g_id" id="go_assign_g_id">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Bid</label>
                            <input id="go_assign_bid_name" class="w-full border border-gray-300 rounded-md px-3 py-2 bg-gray-100" disabled>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Department</label>
                            <input type="text" name="depart" class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="e.g., Business Dev / Design / Operations" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Person Name</label>
                            <input type="text" name="person_name" class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="Enter person name" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" name="email" class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="person@example.com">
                        </div>
                        <div class="flex justify-end space-x-4 mt-6">
                            <button type="button" onclick="closeGoAssignModal()" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-lg">Cancel</button>
                            <button type="submit" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg">Assign</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Auto-submit import when a file is chosen
        const excelInput = document.getElementById('excelInput');
        if (excelInput) {
            excelInput.addEventListener('change', function() {
                if (this.files && this.files.length) {
                    document.getElementById('importForm').submit();
                }
            });
        }
        // Table selector change
        document.getElementById('tableSelector').addEventListener('change', function() {
            const selectedTable = this.value;
            window.location.href = `/database-management?table=${selectedTable}`;
        });

        // Modal helpers
        function openCreateModal() {
            document.getElementById('crudTitle').textContent = 'Create Row';
            const form = document.getElementById('crudForm');
            form.action = '/database-management/create';
            form.method = 'POST';
            document.querySelectorAll('[id^="field_"]').forEach(i => i.value = '');
            document.getElementById('crudModal').classList.remove('hidden');
        }
        function openUpdateModal(id, data) {
            document.getElementById('crudTitle').textContent = 'Update Row';
            const form = document.getElementById('crudForm');
            form.action = `/database-management/update/${id}`;
            form.method = 'POST';
            for (const key in data) {
                const el = document.getElementById(`field_${key}`);
                if (el) el.value = data[key] ?? '';
            }
            document.getElementById('crudModal').classList.remove('hidden');
        }
        function closeCrudModal() {
            document.getElementById('crudModal').classList.add('hidden');
        }

        function deleteRow(id) {
            if (id) {
                if (confirm('Are you sure you want to delete this row? This will also delete all related records in cascading tables.')) {
                    const table = document.getElementById('tableSelector').value;
                    window.location.href = `/database-management/delete/${id}?table=${table}`;
                }
            }
        }

        // Assign helpers
        function openAssignModal(bidId, bidName) {
            document.getElementById('assign_bid_id').value = bidId;
            document.getElementById('assign_bid_name').value = bidName;
            document.getElementById('assignModal').classList.remove('hidden');
        }
        function closeAssignModal() {
            document.getElementById('assignModal').classList.add('hidden');
        }

        function openGoAssignModal(gId, bidName) {
            document.getElementById('go_assign_g_id').value = gId;
            document.getElementById('go_assign_bid_name').value = bidName;
            document.getElementById('goAssignModal').classList.remove('hidden');
        }
        function closeGoAssignModal() {
            document.getElementById('goAssignModal').classList.add('hidden');
        }

        function editRow(id) {
            const row = event.target.closest('tr');
            const data = {};
            const headers = Array.from(row.closest('table').querySelectorAll('thead th'));
            const cells = Array.from(row.querySelectorAll('td'));
            headers.forEach((h, idx) => {
                const key = h.textContent.trim();
                if (key && key !== 'Actions') data[key] = cells[idx]?.textContent.trim();
            });
            openUpdateModal(id, data);
        }

        function dropTable() {
            if (confirm('Are you sure you want to drop this table? This action cannot be undone!')) {
                window.location.href = `/database-management/drop?table={{ selected_table }}`;
            }
        }
    </script>
</body>
</html>
