<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESCO Master Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .timeline-checkpoint { transition: transform 0.2s ease-in-out; z-index: 10; }
        .timeline-checkpoint:hover { transform: scale(1.1); }
        .pulse-ring { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 16px; height: 16px; background-color: #22c55e; border-radius: 50%; animation: pulse-animation 1.5s infinite cubic-bezier(0.455, 0.03, 0.515, 0.955); }
        @keyframes pulse-animation { 0% { transform: translate(-50%, -50%) scale(1); opacity: 0.75; } 100% { transform: translate(-50%, -50%) scale(4); opacity: 0; } }
        #summary-arrow { transition: transform 0.3s ease-in-out; }
        #summary-arrow.rotate-180 { transform: rotate(180deg); }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">
    <div class="flex h-screen">
        
        {% include 'sidebar.html' %}

        <main class="flex-1 p-8 overflow-y-auto">
            <header class="flex justify-between items-center mb-8">
                <h2 class="text-3xl font-bold text-gray-900">ESCO Intelligence Suite</h2>
                <div class="flex items-center">
                    <div class="relative mr-4"><i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i><input type="text" placeholder="Search..." class="bg-white border border-gray-300 rounded-full py-2 pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                    <button class="mr-4 p-2 rounded-full hover:bg-gray-200"><i class="fas fa-bell"></i></button>
                    <div class="flex items-center"><img src="https://placehold.co/40x40/4338ca/ffffff?text=U" alt="User Avatar" class="rounded-full w-10 h-10"></div>
                </div>
            </header>

            <!-- Summary cards (unchanged placement) -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between"><div><p class="text-gray-500 text-sm">Total Projects</p><p data-card="total_bids" class="text-3xl font-bold text-gray-900">{{ data.total_bids }}</p></div><i class="fas fa-file-alt text-4xl text-blue-500"></i></div>
                <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between"><div><p class="text-gray-500 text-sm">Projects Completed</p><p data-card="live_bids" class="text-3xl font-bold text-gray-900">{{ data.live_bids }}</p></div><i class="fas fa-broadcast-tower text-4xl text-red-500"></i></div>
                <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between"><div><p class="text-gray-500 text-sm">Projects (in progress)</p><p data-card="bids_won" class="text-3xl font-bold text-gray-900">{{ data.bids_won }}</p></div><i class="fas fa-trophy text-4xl text-green-500"></i></div>
                <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between"><div><p class="text-gray-500 text-sm">Project (on hold)</p><p data-card="projects_completed" class="text-3xl font-bold text-gray-900">{{ data.projects_completed }}</p></div><i class="fas fa-check-circle text-4xl text-yellow-500"></i></div>
            </div>

            <!-- Interactive Timeline Trackers Container (unchanged) -->
            <div class="bg-gray-50 p-8 rounded-xl shadow-lg mb-8">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">BID Timeline</h2>
                    <p class="text-gray-600">Top 5 High Priority BIDs - All Companies</p>
                </div>
                
                <div class="space-y-8" id="go-projects-top">
                {% for item in go_projects_top5 %}
                <!-- Project Timeline Tracker {{ loop.index }} -->
                <div class="bg-white p-8 rounded-lg shadow-md" data-bid-card="{{ item.g_id }}" data-stage-map='{{ (item.stage_progress_map|default({}))|tojson|safe }}'>
                    <div class="flex justify-between items-center mb-12">
                        <h3 class="text-xl font-semibold text-gray-900">{{ item.b_name }}</h3>
                        <div class="flex items-center space-x-4">
                            <span class="px-3 py-1 bg-blue-100 text-blue-600 text-sm font-semibold rounded-full">{{ item.company }}</span>
                            <button class="timeline-summary-toggle flex items-center text-sm font-semibold text-blue-600 hover:text-blue-800">
                                <span>Dropdown for Summary</span>
                                <i class="fas fa-chevron-down ml-2"></i>
                            </button>
                        </div>
                    </div>
                    <div class="relative w-full">
                        <div class="absolute top-4 left-0 w-full h-1 bg-gray-200"></div>
                        <div class="timeline-segments">
                            {% set seg_count = (item.stages|length - 1) if (item.stages|length - 1) > 0 else 0 %}
                            {% if seg_count > 0 %}
                                {% for i in range(seg_count) %}
                                    {% set seg_stage = item.stages[i] %}
                                    {% set map = item.stage_progress_map or {} %}
                                    {% set sp = map.get(seg_stage, 0) %}
                                    {% set leftpct = (100 * i / seg_count) %}
                                    {% set widthpct = (sp / seg_count) %}
                                    <div class="segment-progress absolute top-4 h-1 bg-green-500" data-stage="{{ seg_stage }}" style="left: {{ '%.2f'|format(leftpct) }}%; width: {{ '%.2f'|format(widthpct) }}%; z-index: 1;"></div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <div class="timeline-dot hidden absolute top-4 left-0 h-8 w-8 -translate-x-1/2 -translate-y-1/2" style="left: 0%; z-index: 20;">
                            <div class="relative w-full h-full flex items-center justify-center">
                                <div class="w-4 h-4 bg-green-500 rounded-full border-2 border-white shadow-lg"></div>
                            </div>
                        </div>
                        <div class="relative flex justify-between">
                            {% for st in item.stages %}
                            <div class="timeline-checkpoint text-center cursor-pointer" data-stage="{{ st }}">
                                {# compute threshold dynamically #}
                                {% set index = loop.index0 %}
                                {% set pct = (100 * index // (item.stages|length - 1)) if (item.stages|length - 1) > 0 else 0 %}
                                <div class="checkpoint-circle w-8 h-8 {% if item.stage_progress >= pct %}bg-green-500{% else %}bg-gray-300{% endif %} border-4 border-white rounded-full mx-auto"></div>
                                <p class="mt-2 font-semibold">{{ st.title() }}</p>
                                <div class="mt-1 w-16 mx-auto">
                                    {% set map = item.stage_progress_map or {} %}
                                    {% set sp = map.get(st, 0) %}
                                    <div class="w-full bg-gray-200 rounded-full h-1">
                                        <div class="bg-green-500 h-1 rounded-full" style="width: {{ sp }}%"></div>
                                    </div>
                                    <p class="text-[10px] text-gray-500 text-center mt-1">{{ sp }}%</p>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="timeline-summary hidden mt-12 p-6 bg-white rounded-lg border border-gray-200 shadow-sm">
                        <h4 class="text-lg font-semibold text-blue-600 mb-6">{{ item.b_name }} - Summary</h4>
                        <div class="timeline-summary-content">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <!-- Key Points -->
                                <div>
                                    <h5 class="font-semibold text-gray-700 mb-4">Key Points</h5>
                                    <div class="space-y-3">
                                        <div class="flex justify-between">
                                            <span class="font-medium text-gray-600">Company:</span>
                                            <span class="text-gray-900">{{ item.company }}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="font-medium text-gray-600">Due Date:</span>
                                            <span class="text-gray-900">{{ item.due_date }}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="font-medium text-gray-600">Decision:</span>
                                            <span class="text-gray-900">{{ item.decision or '-' }}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="font-medium text-gray-600">Project Status:</span>
                                            <span class="text-gray-900" data-summary="project-status">{{ item.project_status }}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="font-medium text-gray-600">Work Status:</span>
                                            <span class="text-gray-900" data-summary="work-status">{{ item.work_status }}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="font-medium text-gray-600">Description:</span>
                                            <span class="text-gray-900 text-right max-w-xs">{{ item.summary or '-' }}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Work Progress -->
                                <div>
                                    <h5 class="font-semibold text-gray-700 mb-4">Work Progress</h5>
                                    <div class="space-y-4">
                                        <div class="w-full bg-gray-200 rounded-full h-4">
                                            <div class="bg-blue-600 h-4 rounded-full transition-all duration-300" 
                                                 data-summary="progress" style="width: {{ item.work_progress_pct }}%"></div>
                                        </div>
                                        <div class="text-center">
                                            <span class="text-lg font-semibold text-gray-700" data-summary="progress-pct">{{ item.work_progress_pct }}%</span>
                                        </div>
                                        <div class="text-sm text-gray-600 text-center">
                                            Progress based on current stage completion
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                </div>

                {% if go_projects_more %}
                <div class="text-center mt-6">
                    <button class="px-4 py-2 bg-blue-600 text-white rounded" id="toggle-more-btn">Show more</button>
                </div>
                <div class="space-y-8 mt-6 hidden" id="go-projects-more">
                    {% for item in go_projects_more %}
                    <div class="bg-white p-8 rounded-lg shadow-md" data-bid-card="{{ item.g_id }}" data-stage-map='{{ (item.stage_progress_map|default({}))|tojson|safe }}'>
                        <div class="flex justify-between items-center mb-12">
                            <h3 class="text-xl font-semibold text-gray-900">{{ item.b_name }}</h3>
                            <div class="flex items-center space-x-4">
                                <span class="px-3 py-1 bg-blue-100 text-blue-600 text-sm font-semibold rounded-full">{{ item.company }}</span>
                                <button class="timeline-summary-toggle flex items-center text-sm font-semibold text-blue-600 hover:text-blue-800">
                                    <span>Dropdown for Summary</span>
                                    <i class="fas fa-chevron-down ml-2"></i>
                                </button>
                            </div>
                        </div>
                        <div class="relative w-full">
                            <div class="absolute top-4 left-0 w-full h-1 bg-gray-200"></div>
                            <div class="timeline-segments">
                                {% set seg_count = (item.stages|length - 1) if (item.stages|length - 1) > 0 else 0 %}
                                {% if seg_count > 0 %}
                                    {% for i in range(seg_count) %}
                                        {% set seg_stage = item.stages[i] %}
                                        {% set map = item.stage_progress_map or {} %}
                                        {% set sp = map.get(seg_stage, 0) %}
                                        {% set leftpct = (100 * i / seg_count) %}
                                        {% set widthpct = (sp / seg_count) %}
                                        <div class="segment-progress absolute top-4 h-1 bg-green-500" data-stage="{{ seg_stage }}" style="left: {{ '%.2f'|format(leftpct) }}%; width: {{ '%.2f'|format(widthpct) }}%; z-index: 1;"></div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            <div class="timeline-dot hidden absolute top-4 left-0 h-8 w-8 -translate-x-1/2 -translate-y-1/2" style="left: 0%; z-index: 20;">
                                <div class="relative w-full h-full flex items-center justify-center">
                                    <div class="w-4 h-4 bg-green-500 rounded-full border-2 border-white shadow-lg"></div>
                                </div>
                            </div>
                            <div class="relative flex justify-between">
                                {% for st in item.stages %}
                                {% set index = loop.index0 %}
                                {% set pct = (100 * index // (item.stages|length - 1)) if (item.stages|length - 1) > 0 else 0 %}
                                <div class="timeline-checkpoint text-center cursor-pointer" data-stage="{{ st }}">
                                    <div class="checkpoint-circle w-8 h-8 {% if item.stage_progress >= pct %}bg-green-500{% else %}bg-gray-300{% endif %} border-4 border-white rounded-full mx-auto"></div>
                                    <p class="mt-2 font-semibold">{{ st.title() }}</p>
                                    <div class="mt-1 w-16 mx-auto">
                                        {% set map = item.stage_progress_map or {} %}
                                        {% set sp = map.get(st, 0) %}
                                        <div class="w-full bg-gray-200 rounded-full h-1">
                                            <div class="bg-green-500 h-1 rounded-full" style="width: {{ sp }}%"></div>
                                        </div>
                                        <p class="text-[10px] text-gray-500 text-center mt-1">{{ sp }}%</p>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="timeline-summary hidden mt-12 p-6 bg-white rounded-lg border border-gray-200 shadow-sm">
                            <h4 class="text-lg font-semibold text-blue-600 mb-6">{{ item.b_name }} - Summary</h4>
                            <div class="timeline-summary-content">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    <div>
                                        <h5 class="font-semibold text-gray-700 mb-4">Key Points</h5>
                                        <div class="space-y-3">
                                            <div class="flex justify-between">
                                                <span class="font-medium text-gray-600">Company:</span>
                                                <span class="text-gray-900">{{ item.company }}</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="font-medium text-gray-600">Due Date:</span>
                                                <span class="text-gray-900">{{ item.due_date }}</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="font-medium text-gray-600">Decision:</span>
                                                <span class="text-gray-900">{{ item.decision or '-' }}</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="font-medium text-gray-600">Project Status:</span>
                                                <span class="text-gray-900" data-summary="project-status">{{ item.project_status }}</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="font-medium text-gray-600">Work Status:</span>
                                                <span class="text-gray-900" data-summary="work-status">{{ item.work_status }}</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="font-medium text-gray-600">Description:</span>
                                                <span class="text-gray-900 text-right max-w-xs">{{ item.summary or '-' }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <h5 class="font-semibold text-gray-700 mb-4">Work Progress</h5>
                                        <div class="space-y-4">
                                            <div class="w-full bg-gray-200 rounded-full h-4">
                                                <div class="bg-blue-600 h-4 rounded-full transition-all duration-300" 
                                                     data-summary="progress" style="width: {{ item.work_progress_pct }}%"></div>
                                            </div>
                                            <div class="text-center">
                                                <span class="text-lg font-semibold text-gray-700" data-summary="progress-pct">{{ item.work_progress_pct }}%</span>
                                            </div>
                                            <div class="text-sm text-gray-600 text-center">
                                                Progress based on current stage completion
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                </div>
            

            <!-- Won Projects Timeline -->
            <div class="bg-gray-50 p-8 rounded-xl shadow-lg mb-8">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">Projects Timeline</h2>
                    <p class="text-gray-600">Latest 5 won projects across companies</p>
                </div>
                <div class="space-y-8">
                {% for item in won_projects %}
                <div class="bg-white p-8 rounded-lg shadow-md" data-bid-card="{{ item.g_id }}" data-stage-map='{{ (item.stage_progress_map|default({}))|tojson|safe }}'>
                    <div class="flex justify-between items-center mb-12">
                        <h3 class="text-xl font-semibold text-gray-900">{{ item.b_name }}</h3>
                        <div class="flex items-center space-x-4">
                            <span class="px-3 py-1 bg-green-100 text-green-700 text-sm font-semibold rounded-full">{{ item.company }}</span>
                            <button class="timeline-summary-toggle flex items-center text-sm font-semibold text-blue-600 hover:text-blue-800">
                                <span>Dropdown for Summary</span>
                                <i class="fas fa-chevron-down ml-2"></i>
                            </button>
                        </div>
                    </div>
                    <div class="relative w-full">
                        <div class="absolute top-4 left-0 w-full h-1 bg-gray-200"></div>
                        <div class="timeline-segments">
                            {% set seg_count = (item.stages|length - 1) if (item.stages|length - 1) > 0 else 0 %}
                            {% if seg_count > 0 %}
                                {% for i in range(seg_count) %}
                                    {% set seg_stage = item.stages[i] %}
                                    {% set map = item.stage_progress_map or {} %}
                                    {% set sp = map.get(seg_stage, 0) %}
                                    {% set leftpct = (100 * i / seg_count) %}
                                    {% set widthpct = (sp / seg_count) %}
                                    <div class="segment-progress absolute top-4 h-1 bg-green-500" data-stage="{{ seg_stage }}" style="left: {{ '%.2f'|format(leftpct) }}%; width: {{ '%.2f'|format(widthpct) }}%; z-index: 1;"></div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <div class="timeline-dot hidden absolute top-4 left-0 h-8 w-8 -translate-x-1/2 -translate-y-1/2" style="left: 0%; z-index: 20;">
                            <div class="relative w-full h-full flex items-center justify-center">
                                <div class="w-4 h-4 bg-green-500 rounded-full border-2 border-white shadow-lg"></div>
                            </div>
                        </div>
                        <div class="relative flex justify-between">
                            {% for st in item.stages %}
                            <div class="timeline-checkpoint text-center" data-stage="{{ st }}">
                                <div class="checkpoint-circle w-8 h-8 bg-gray-300 border-4 border-white rounded-full mx-auto"></div>
                                <p class="mt-2 font-semibold">{{ st.title() }}</p>
                                <div class="mt-1 w-16 mx-auto">
                                    {% set map = item.stage_progress_map or {} %}
                                    {% set sp = map.get(st, 0) %}
                                    <div class="w-full bg-gray-200 rounded-full h-1">
                                        <div class="bg-green-500 h-1 rounded-full" style="width: {{ sp }}%"></div>
                                    </div>
                                    <p class="text-[10px] text-gray-500 text-center mt-1">{{ sp }}%</p>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="timeline-summary hidden mt-12 p-6 bg-white rounded-lg border border-gray-200 shadow-sm">
                        <h4 class="text-lg font-semibold text-blue-600 mb-6">{{ item.b_name }} - Summary</h4>
                        <div class="timeline-summary-content">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div>
                                    <h5 class="font-semibold text-gray-700 mb-4">Key Points</h5>
                                    <div class="space-y-3">
                                        <div class="flex justify-between">
                                            <span class="font-medium text-gray-600">Company:</span>
                                            <span class="text-gray-900">{{ item.company }}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="font-medium text-gray-600">Due Date:</span>
                                            <span class="text-gray-900">{{ item.due_date }}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="font-medium text-gray-600">Decision:</span>
                                            <span class="text-gray-900">{{ item.decision or '-' }}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="font-medium text-gray-600">Project Status:</span>
                                            <span class="text-gray-900" data-summary="project-status">{{ item.project_status }}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="font-medium text-gray-600">Work Status:</span>
                                            <span class="text-gray-900" data-summary="work-status">{{ item.work_status }}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="font-medium text-gray-600">Description:</span>
                                            <span class="text-gray-900 text-right max-w-xs">{{ item.summary or '-' }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h5 class="font-semibold text-gray-700 mb-4">Work Progress</h5>
                                    <div class="space-y-4">
                                        <div class="w-full bg-gray-200 rounded-full h-4">
                                            <div class="bg-blue-600 h-4 rounded-full transition-all duration-300" data-summary="progress" style="width: {{ item.work_progress_pct }}%"></div>
                                        </div>
                                        <div class="text-center">
                                            <span class="text-lg font-semibold text-gray-700" data-summary="progress-pct">{{ item.work_progress_pct }}%</span>
                                        </div>
                                        <div class="text-sm text-gray-600 text-center">Progress based on current stage completion</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                </div>
            </div>

            <!-- Analyzer block: keep old format, right of the side panel (flush right) -->
            <div class="mb-8">
                <h3 class="text-xl font-semibold text-gray-900 mb-6">BID Analyzer</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h4 class="text-gray-500 text-sm font-medium mb-2">Total Bids</h4>
                        <p id="ba-total-bids" class="text-4xl font-bold text-gray-900">{{ bid_stats.total_bids }}</p>
                    </div>
                    <div class="space-y-4">
                        <div class="bg-white p-4 rounded-lg shadow-md">
                            <h4 class="text-gray-500 text-sm font-medium mb-2">Bids GO</h4>
                            <p id="ba-bids-go" class="text-3xl font-bold text-green-600">{{ bid_stats.bids_go }}</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-md">
                            <h4 class="text-gray-500 text-sm font-medium mb-2">Bids NO-GO</h4>
                            <p id="ba-bids-no-go" class="text-3xl font-bold text-red-600">{{ bid_stats.bids_no_go }}</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h4 class="text-gray-500 text-sm font-medium mb-2">Bids Submitted</h4>
                        <p id="ba-bids-submitted" class="text-4xl font-bold text-blue-600">{{ bid_stats.bids_submitted }}</p>
                    </div>
                    <div class="space-y-4">
                        <div class="bg-white p-4 rounded-lg shadow-md">
                            <h4 class="text-gray-500 text-sm font-medium mb-2">Bids Won</h4>
                            <p id="ba-bids-won" class="text-3xl font-bold text-green-600">{{ bid_stats.bids_won }}</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-md">
                            <h4 class="text-gray-500 text-sm font-medium mb-2">Bids Lost</h4>
                            <p id="ba-bids-lost" class="text-3xl font-bold text-gray-600">{{ bid_stats.bids_lost }}</p>
                        </div>
                    </div>
                </div>
                </div>
            </div>

            <!-- Live Activity Log -->
            <!--  or not -->

        </div>

            

        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const btn = document.getElementById('toggle-more-btn');
            const more = document.getElementById('go-projects-more');
            if (btn && more) {
                btn.addEventListener('click', function() {
                    const isHidden = more.classList.contains('hidden');
                    if (isHidden) {
                        more.classList.remove('hidden');
                        btn.textContent = 'Show less';
                    } else {
                        more.classList.add('hidden');
                        btn.textContent = 'Show more';
                    }
                });
            }
            const socket = io();
            socket.on('master_update', function(data) {
                const bidsTableBody = document.getElementById('bids-table-body');
                const existingBidRow = document.getElementById(`master-bid-${data.bid.id}`);
                if (existingBidRow) {
                    existingBidRow.querySelector('.stage-text').textContent = data.bid.current_stage.charAt(0).toUpperCase() + data.bid.current_stage.slice(1);
                }

                // Update top summary cards
                if (data.cards) {
                    const { total_bids, live_bids, bids_won, projects_completed } = data.cards;
                    const totalBidsEl = document.querySelector('.grid .bg-white p.text-3xl');
                    // Fallback: update by known ids if present
                    const cardTotal = document.querySelector('[data-card="total_bids"]');
                    const cardLive = document.querySelector('[data-card="live_bids"]');
                    const cardWon = document.querySelector('[data-card="bids_won"]');
                    const cardProj = document.querySelector('[data-card="projects_completed"]');
                }

                // Update bid analyzer small cards
                if (data.bid_stats) {
                    const s = data.bid_stats;
                    const setText = (id, value) => { const el = document.getElementById(id); if (el) el.textContent = value; };
                    setText('ba-total-bids', s.total_bids);
                    setText('ba-bids-go', s.bids_go);
                    setText('ba-bids-no-go', s.bids_no_go);
                    setText('ba-bids-submitted', s.bids_submitted);
                    setText('ba-bids-won', s.bids_won);
                    setText('ba-bids-lost', s.bids_lost);
                }

                // Add to activity log
                if (data.log) {
                    addToActivityLog(data.log);
                }

                // Handle assignment updates
                if (data.assignment) {
                    // Refresh the page to show updated assignments
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                }

                // Handle summary updates for live progress bar and status
                    if (data.summary) {
                    // Update progress bar
                    const progressBar = document.querySelector('[data-summary="progress"]');
                    const progressText = document.querySelector('[data-summary="progress-pct"]');
                    if (progressBar && progressText) {
                        progressBar.style.width = data.summary.work_progress_pct + '%';
                        progressText.textContent = data.summary.work_progress_pct + '%';
                    }
                    
                    // Update status texts
                    const projectStatus = document.querySelector('[data-summary="project-status"]');
                    const workStatus = document.querySelector('[data-summary="work-status"]');
                    if (projectStatus) projectStatus.textContent = data.summary.project_status;
                    if (workStatus) workStatus.textContent = data.summary.work_status;

                    // Update per-stage progress under each checkpoint if provided
                    if (data.summary.stage_progress_map) {
                        // If bid_id is sent, scope updates to that bid card only
                        const container = data.summary.bid_id ? document.querySelector(`[data-bid-card="${data.summary.bid_id}"]`) : null;
                        if (!container) return; // scope strictly per-bid
                        const checkpoints = container.querySelectorAll('.timeline-checkpoint');

                        // Update small per-stage bars/labels
                        checkpoints.forEach(cp => {
                            const st = (cp.getAttribute('data-stage') || '').toLowerCase();
                            const pct = data.summary.stage_progress_map[st];
                            if (typeof pct === 'number') {
                                const bar = cp.querySelector('.bg-green-500.h-1.rounded-full');
                                const label = cp.querySelector('p.text-[10px]');
                                if (bar) bar.style.width = pct + '%';
                                if (label) label.textContent = pct + '%';
                            }
                        });

                        // Update each segment bar (no cumulative; 1:1 with stage %)
                        const segCount = Math.max(0, checkpoints.length - 1);
                        const segments = container.querySelectorAll('.segment-progress');
                        if (segCount > 0 && segments.length === segCount) {
                            for (let i = 0; i < segCount; i++) {
                                const segStage = (checkpoints[i].getAttribute('data-stage') || '').toLowerCase();
                                const pct = Number(data.summary.stage_progress_map[segStage] || 0);
                                const widthPct = pct / segCount; // segment width is fixed 100/segCount, fill = stage% of that
                                segments[i].style.width = widthPct + '%';
                            }
                        }
                    }
                }
            });

            // Handle all timeline trackers
            const timelineTrackers = document.querySelectorAll('.bg-white.p-8.rounded-lg.shadow-md');
            
            timelineTrackers.forEach((tracker, trackerIndex) => {
                const checkpoints = tracker.querySelectorAll('.timeline-checkpoint');
                const timelineDot = tracker.querySelector('.timeline-dot');
                const progressLine = tracker.querySelector('.timeline-progress');
                const summaryToggle = tracker.querySelector('.timeline-summary-toggle');
                const timelineSummary = tracker.querySelector('.timeline-summary');
                const summaryTitle = timelineSummary ? timelineSummary.querySelector('h4') : null;
                const summaryContent = timelineSummary ? timelineSummary.querySelector('.timeline-summary-content') : null;

                // Initial compute from embedded stage map
                try {
                    const mapAttr = tracker.getAttribute('data-stage-map');
                    if (mapAttr) {
                        const stageMap = JSON.parse(mapAttr);
                        const segCount = Math.max(0, checkpoints.length - 1);
                        if (segCount > 0) {
                            const segments = tracker.querySelectorAll('.segment-progress');
                            for (let i = 0; i < segCount; i++) {
                                const segStage = (checkpoints[i].getAttribute('data-stage') || '').toLowerCase();
                                const pct = Number(stageMap[segStage] || 0);
                                const widthPct = pct / segCount;
                                if (segments[i]) segments[i].style.width = widthPct + '%';
                            }
                        }
                    }
                } catch (e) {
                    // ignore json errors
                }

                // Ensure any legacy single progress line is hidden (we now use per-segment bars)
                if (progressLine) { progressLine.style.width = '0%'; progressLine.classList.add('hidden'); }
                if (timelineDot) { timelineDot.classList.add('hidden'); }

                // Timeline item click handlers
                checkpoints.forEach((checkpoint, index) => {
                    checkpoint.addEventListener('click', function() {
                        const stage = this.dataset.stage;
                        
                        // Update dot position based on checkpoint index
                        const itemPosition = (index / (checkpoints.length - 1)) * 100;
                        timelineDot.style.left = itemPosition + '%';
                        
                        // Update progress line
                        progressLine.style.width = itemPosition + '%';
                        
                        // Update active checkpoint visual
                        checkpoints.forEach(cp => {
                            cp.querySelector('.checkpoint-circle').classList.remove('bg-green-500');
                            cp.querySelector('.checkpoint-circle').classList.add('bg-gray-300');
                            const badge = cp.querySelector('span');
                            if (badge) {
                                badge.classList.remove('bg-blue-100', 'text-blue-600');
                                badge.classList.add('bg-gray-200', 'text-gray-600');
                            }
                        });
                        
                        // Make clicked checkpoint active
                        this.querySelector('.checkpoint-circle').classList.remove('bg-gray-300');
                        this.querySelector('.checkpoint-circle').classList.add('bg-green-500');
                        const activeBadge = this.querySelector('span');
                        if (activeBadge) {
                            activeBadge.classList.remove('bg-gray-200', 'text-gray-600');
                            activeBadge.classList.add('bg-blue-100', 'text-blue-600');
                        }
                        
                        // Update summary
                        if (summaryTitle && summaryContent) {
                            updateSummary(stage, summaryTitle, summaryContent);
                        }
                    });
                });

                // Summary toggle
                if (summaryToggle && timelineSummary) {
                    summaryToggle.addEventListener('click', function() {
                        timelineSummary.classList.toggle('hidden');
                        const arrow = this.querySelector('i');
                        if (arrow) arrow.classList.toggle('rotate-180');
                    });
                }
            });

            // Also update won projects when real-time data comes in
            // Re-use the same handler since markup is identical

            function updateSummary(stage, summaryTitle, summaryContent) {
            const summaryData = {
                    analyzer: {
                        title: "BID Analyzer Summary",
                        content: [
                            "Review of tender documents and project scope.",
                            "Conduct initial viability and profitability assessment.",
                            "Plan for necessary resource allocation."
                        ]
                    },
                    business: {
                        title: "Business Development Summary",
                        content: [
                            "Making of Proposals",
                            "Creation of Helioscope Reports",
                            "Track and nurture incoming leads",
                            "Maintain regular client follow-ups and communication"
                        ]
                    },
                    design: {
                        title: "Design Team Summary",
                        content: [
                            "Preparation of detailed technical drawings",
                            "Creation of Single-Line Diagrams (SLD)",
                            "Finalization of the Bill of Quantities (BOQ)"
                        ]
                    },
                    operations: {
                        title: "Operations Summary",
                        content: [
                            "Conduct project kick-off meetings with stakeholders",
                            "Manage procurement of materials and equipment",
                            "Coordinate and manage vendors and subcontractors",
                            "Develop and maintain the project execution schedule"
                        ]
                    },
                    engineer: {
                        title: "Site Engineer Summary",
                        content: [
                            "Provide on-site supervision of all activities",
                            "Implement and monitor quality control checks",
                            "Manage the installation process from start to finish",
                            "Compile and submit daily progress reports"
                        ]
                    },
                    handover: {
                        title: "Handover / Closure Summary",
                        content: [
                            "Compile and deliver all final project documentation",
                            "Provide client training and a final project walkthrough",
                            "Finalize warranty and ongoing service agreements",
                            "Complete the official project closure process"
                        ]
                    }
                };

                const data = summaryData[stage];
                if (data) {
                    summaryTitle.textContent = data.title;
                    summaryContent.innerHTML = data.content.map(item => 
                        `<p class="text-sm text-gray-600">${item}</p>`
                    ).join('');
                }
            }

            // Activity log functionality
            function addToActivityLog(logData) {
                const logContainer = document.getElementById('activity-log');
                if (!logContainer) return;
                
                // Remove the placeholder message if it exists
                const placeholder = logContainer.querySelector('p.text-gray-500');
                if (placeholder) {
                    placeholder.remove();
                }
                
                const logEntry = document.createElement('div');
                logEntry.className = 'flex items-center space-x-3 p-3 bg-gray-50 rounded-lg border-l-4 border-blue-500';
                
                const timestamp = new Date().toLocaleTimeString();
                logEntry.innerHTML = `
                    <div class="flex-shrink-0">
                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm text-gray-900">${logData.action}</p>
                        <p class="text-xs text-gray-500">${logData.user_email} (${logData.user_role}) â€¢ ${timestamp}</p>
                    </div>
                `;
                
                // Add to top of log
                logContainer.insertBefore(logEntry, logContainer.firstChild);
                
                // Keep only last 20 entries
                while (logContainer.children.length > 20) {
                    logContainer.removeChild(logContainer.lastChild);
                }
            }

            // Update summary data for live updates
            function updateSummaryData(bidId, summaryData) {
                // Find the timeline tracker for this bid
                const trackers = document.querySelectorAll('.bg-white.p-8.rounded-lg.shadow-md');
                trackers.forEach(tracker => {
                    const bidName = tracker.querySelector('h3').textContent;
                    if (bidName.includes(bidId) || bidName.includes(summaryData.bid_name)) {
                        // Update progress bar
                        const progressBar = tracker.querySelector('.bg-blue-600.h-4.rounded-full');
                        const progressText = tracker.querySelector('.text-lg.font-semibold.text-gray-700');
                        if (progressBar && progressText) {
                            progressBar.style.width = `${summaryData.work_progress_pct}%`;
                            progressText.textContent = `${summaryData.work_progress_pct}%`;
                        }
                        
                        // Update status texts
                        const projectStatus = tracker.querySelector('span:contains("Project Status")')?.nextElementSibling;
                        const workStatus = tracker.querySelector('span:contains("Work Status")')?.nextElementSibling;
                        
                        // Find status elements by looking for the text content
                        const statusElements = tracker.querySelectorAll('.timeline-summary span');
                        statusElements.forEach(span => {
                            if (span.textContent.includes('Project Status:')) {
                                const nextSpan = span.parentElement.querySelector('.text-gray-900');
                                if (nextSpan) nextSpan.textContent = summaryData.project_status;
                            }
                            if (span.textContent.includes('Work Status:')) {
                                const nextSpan = span.parentElement.querySelector('.text-gray-900');
                                if (nextSpan) nextSpan.textContent = summaryData.work_status;
                            }
                        });
                    }
                });
            }
        });
    </script>
</body>
</html>